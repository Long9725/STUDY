## 목차

1. [Interrupts란?](#interrupts란?)
2. [역할](#역할)
3. [목적](#목적)
4. [References](#references)

## 컴퓨터 구조
(추후 컴퓨터 구조 폴더로 이동할 예정) \
https://jaebworld.tistory.com/27 를 참고하였습니다.\
CPU와 Main memory는 Memory bus에 연결되어 있다. GPU나 다른 고성능 I/O 장치들은 PCI와 같은 General I/O Bus에 연결된다. 그 아래에는 SCSI, SATS, USB와 같은 주변장치용 I/O 버스가 있다. \
이러한 구조를 가지는 이유는 비용 때문이다. 버스가 고속화되려면 길이가 짧아져야 하는데, 그만큼 수용할 수 있는 장치의 종류가 줄어들며 비용도 비싸진다. 따라서 고성능의 장치들을 CPU에 가깝게 배치하고 느린 장치들을 주변장치 I/O 버스에 연결하도록 배치한다.

![](../image/process/polling%26interrupts/computer%20architecture.png)
![](../image/process/polling%26interrupts/mainboard.jpeg)

### PCI
1992년 6월에 컴퓨터에서 주변기기 장착을 위해 발표된 버스 규격으로, 컴퓨터 메인보드에 주변 장치를 장착하는데 쓰이는 컴퓨터 버스의 일종이다. 32비트와 64비트 규격이 있다. 메인보드에서 RAM을 장착하는 곳이다.

![](../image/process/polling%26interrupts/PCI.jpeg)

### ISA
PCI와 마찬가지로 컴퓨터 메인보드에 주변 장치를 장착하는데 쓰이는 컴퓨터 버스의 일종이다. 16비트로, 현재 CPU가 32비트/64비트를 사용함에 따라 PCI로 대체되었다. 

### 표준 장치
+ 하드웨어 인터페이스: 시스템의 다른 구성요소에게 제공하는 인터페이스이다. 시스템 소프트웨어가 동작을 제어할 수 있도록 하기 위해서, 하드웨어는 특정한 상호 동작을 위한 방식과 인터페이스를 갖는다.
    + USB, HDMI를 연결하는 것을 상상해보자. USB는 Universal Serial Bus의 약자로 컴퓨터와 주변 장치를 연결하기 위해서 만들어진 하드웨어 인터페이스이다.
+ 내부구조: 시스템에게 제공하는 장치에 대한 추상화를 정의하는 책임을 갖는다.
    + 내부구조는 위에서 살펴본 메인보드와도 같다. 사용자는 CPU나 그래픽카드에 잘 알지 못하더라도, 이들을 잘 활용할 수 있어야한다. 이렇게 추상화를 정의하는 책임을 가져야한다.

![](../image/process/polling%26interrupts/general%20device.png)

위 그림에서 인터페이스는 상태(Status), 명령(Command), 데이터(Data) 3개의 레지스터로 구성되어 있다.

+ 상태 레지스터: 하드웨어의 현재 상태를 읽을 수 있는 레지스터이다.
+ 명령 레지스터: 하드웨어장치가 특정 동작을 하도록 요청할 때 사용하는 레지스터이다.
+ 데이터 레지스터: 하드웨어 장치에 데이터르 보내거나 받을 때 사용하는 레지스터이다.

운영체제는 이러한 레지스터들을 읽고 쓰는 것을 통해, 하드웨어 장치의 동작을 제어할 수 있게 된다.

* * *

## Polling
CPU가 일정한 시간 간격을 두고 각 자원들의 상태를 주기적으로 확인하는 방식이다. 자원들은 폴링 신호를 받은 후에 자신의 상태를 CPU에게 알려준다. 동시에 각 자원들은 직전 폴링 이후 변화된 자신의 상태를 다음 폴링 때까지는 알릴 수 없다. 운영체제와 하드웨어장치 간에 폴링을 통한 상호동작은 다음과 같다.
1. 폴링을 한다.
2. 운영체제가 데이터레지스터에 데이터를 전달한다.
3. 운영체제가 명령레지스터에 명령을 기록한다.
4. 운영체제는 하드웨어 장치가 특정 동작을 처리하였는지 폴링 반복문을 돌면서 기다린다. (성공 / 실패 코드를 받는다.)

폴링을 하는 동안에는 다른 프로세스에게 CPU를 양도하지 않는다. 하드웨어 장치가 동작을 완료하는 동안 계속 루프를 돌면서 하드웨어의 상태를 체크한다. 하지만 하드웨어 장치의 속도는 CPU에 비해 매우 느리기 때문에, CPU를 양도하지 않고 하드웨어 장치의 상태를 계속 확인하는 것은 CPU를 많이 낭비하게 된다. 

* * * 

## Interrupts란?
CPU가 프로그램을 실행하고 있을 때, I/O 하드웨어 등의 장치에 예외 상황이 발생하여 처리가 필요할 경우에 CPU에게 알려 처리할 수 있도록 하는 것을 말한다. \
대부분의 컴퓨터는 한 개의 CPU를 사용하므로 한 순간에는 하나의 일 밖에 처리할 수 없다. 어떤 일을 처리하던 도중, 우선 순위가 급한 일을 처리할 필요가 있을 때의 대처 방안이다.

### 우선순위
동시에 여러 개의 인터럽트가 발생할 때, 우선 순위를 정해 순차적으로 처리한다.
1. 전원 공급의 이상
2. CPU의 기계적인 오류
3. 외부 신호에 의한 인터럽트
4. 입출력 전송 요청 및 전송 완료, 전송 오류
5. 프로그램 검사 인터럽트
6. 수퍼바이저 호출(SVC 인터럽트)

### 서비스 루틴
다음은 위키백과에서 가져왔습니다.
인터럽트 원천인 하드웨어에서 또는 예외상황이 발생하거나 소프트웨어 인터럽트가 걸리면:

1. 현재 진행 중인 기계어 코드를 완료한다.
2. CPU의 특수레지스터 중, 하이로인터럽트 마스크 비트를 보고 마스크 되면 인터럽트 무시 한다.
3. 인터럽트 벡터를 읽고
4. ISR 주소값을 얻는다.
5. ISR로 점프 한다. 이때 PC(Program Counter, IP) 값은 자동 대피 저장된다.
6. 현재 진행중인 프로그램의 레지스터를 대피한다.
7. 해당 코드를 실행한다.
8. 해당 일을 다 처리하면, 대피시킨 레지스터를 복원한다.
9. ISR의 끝에 IRET 명령어에 의해 인터럽트가 해제 된다.
10. IRET 명령어가 실행되면, 대피시킨 PC 값을 복원하여 이전 실행 위치로 복원한다.

### 용어
* PC: Program Counter, IP. 마이크로프로세서 내부에 있는 레지스터 중의 하나. 다음에 실행될 명령어 주소를 가지고 있어 실행할 기계어 코드의 위치를 지정한다. 명령어 포인터라고도 한다.
* ISR: Interrupt Service Routine, interrupt handler. 인터럽트에 대응하여 특정 기능을 처리하는 기계어 코드 루틴이다. 인터럽트 원인에 따라 각각 존재한다.

## 특별한 Interrupts가 없는 상태의 Polling
프로세스 1이 실행 중에 DISK로부터 I/O 요청을 발생시키고, 운영체제는 이 요청이 완료될 때까지 Flag를 조사하면서 반복적으로 폴링을 한다. 이 때, CPU는 아무것도 하지 못 한다. 디스크가 요청을 완료하면 프로세스 1은 다시 동작한다. 

![](../image/process/polling%26interrupts/polling.png)

어떠한 작업이 단 한 번의 폴링으로 끝날 정도의 하드웨어라면 인터럽트보다는 폴링이 효율적이다. 인터럽트는 Context switching overhead를 발생시키기 때문이다. 하드웨어 장치의 속도가 빠르면 폴링, 느리면 인터럽트가 더 효율적이라고도 할 수 있다. (I/O 요청이 그만큼 빨리 끝나므로 폴링 시간도 줄어든다.)

## Interrupts 도입
프로세스 1이 실행 중에 DISK로부터 I/O 요청을 받고 처리하는 동안, 운영체제는 프로세스 2를 CPU에 실행시킨다. 프로세스1에 대한 디스크 요청이 완료되면 인터럽트를 발생시켜, 운영체제는 프로세스 1을 다시 CPU에 실행시킨다.

![](../image/process/polling%26interrupts/interrupts.png)

## DMA와 Interrupts
대량의 데이터를 디스크로 전달하기 위해서 PIO를 사용한다면, CPU는 디스크와 직접 소통하며 데이터를 디스크에 복사한다. 복사가 완료되면 그제서야 I/O 처리를 하며 Interrupts를 도입할 수 있다. 이 경우 CPU는 다른 프로세스를 처리하기 위해 사용될 수 있는 시간들을 허비한다. 

![](../image/process/polling%26interrupts/non-dma.png)

* * *

따라서 DMA를 도입하고 이를 활용하여 메모리와 장치 사이에 직접 데이터 전송을 한다. CPU와 디스크 간의 데이터 복사를 위한 소통을 DMA가 담당하게 되면서, CPU는 그동안 다른 프로세스를 처리할 수 있게 된다. 


![](../image/process/polling%26interrupts/dma.png)
![](../image/process/polling%26interrupts/dma-interrupts.png)

* * *

## References
* 2022 봄 운영체제 강의
* wiki - https://ko.wikipedia.org/wiki/%EC%9D%B8%ED%84%B0%EB%9F%BD%ED%8A%B8
* 폴링 / 인터럽트 / DMA - https://jaebworld.tistory.com/27
* 인터페이스란? - https://better-together.tistory.com/155
* 인터럽트와 폴링 - https://itdexter.tistory.com/388
* 데이터 입출력 - https://m.blog.naver.com/ionebabo/221519182829